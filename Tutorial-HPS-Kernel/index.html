<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
      
        <title>8. Linux kernel - SoC and Embedded Linux</title>
      
    
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:700|Oxygen+Mono|Source+Sans+Pro:700|Source+Serif+Pro&amp;display=swap">
    <link rel="stylesheet" href="../assets/css/main.css">
    <script>
      // SETUP GLOBAL CONSTANTS
      var base_url = '..';
      
      var telemetryEnabled = true;
      var backendUrl = "http://localhost:8080/api/";
      var courseSlug = "Embedded-Linux-SoC";
      
      
      var dashboardEnabled = false;
      var tagTree = {};
      

      // SETUP PLUGIN
      window.initialized = false;
      if (!window.initializers) window.initializers = [];
      window.registerInitializer = (initialize) => {
        if (window.initialized) initialize();
        else window.initializers.push(initialize);
      };
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://unpkg.com/hyperscript.org"></script>
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
    
    <link rel="stylesheet" href="../termynal.css">
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  <body>
    <div class="ah-main-container">
      <header class="ah-header">
        <button class="ah-menu-btn ah-button ah-button--borderless"
                aria-label="toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/>
</svg>
        </button>
        <a href=".."
           title="SoC and Embedded Linux"
           class="ah-logo"
           aria-label="SoC and Embedded Linux">
          SoC and Embedded Linux
        </a>
        <div class="ah-header--right">
          
          
          
          <button id="resetHandoutButton">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
  <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
</svg></span>
          </button>
          

          
          <div id="user-menu" hx-get="http://localhost:8080/api/user-menu" hx-trigger="load"> </div>
          
        </div>
      </header>
      <nav class="ah-navigation preload">
        <div class="ah-nav-container">
          <button class="ah-menu-btn ah-button ah-button--borderless close-menu"
                  aria-label="close menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"/>
</svg>
          </button>
          <ul class="ah-nav-body">
            
              
  
    <li>
      <a href="..">Home</a>
    </li>
  

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">FPGA</span>
    <ul>
      
        
  
    <li>
      <a href="../Tutorial-FPGA-RTL/">1. RTL</a>
    </li>
  

      
        
  
    <li>
      <a href="../Entrega-1/">🔔 Assessment</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-FPGA-NIOS/">2. NIOS</a>
    </li>
  

      
        
  
    <li>
      <a href="../Entrega-2/">🔔 Assessment</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-FPGA-NIOS-IP/">3. NIOS IP</a>
    </li>
  

      
        
  
    <li>
      <a href="../Entrega-3/">🔔 Assessment</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">HPS</span>
    <ul>
      
        
  
    <li>
      <a href="../Tutorial-HPS/">4. About</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-Running/">5. Embedded Linux</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-BuildSystem/">6. Setup</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-BlinkLED/">7. Blink LED</a>
    </li>
  

      
        
  
    <li>
      <a href="../info-HPS-ethernet/">Extra - Network</a>
    </li>
  

      
        
  
    <li>
      <a href="../Entrega-4/">🔔 Assessment</a>
    </li>
  

      
        
  

    <li class="active ah-togglable-item opened">
      <span class="ah-togglable-handle">8. Linux kernel</span>
      <ul>
        
          
            
            
              <li class="ah-toc-item">
                <a href="#kernel-44">Kernel 4.4</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#configuring-the-kernel">Configuring the Kernel</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#compiling">Compiling</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#testing">Testing</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#mouse-keyboard">Mouse/ Keyboard?</a>
              </li>
            
        
      </ul>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-Buildroot/">9. Buildroot</a>
    </li>
  

      
        
  
    <li>
      <a href="../info-HPS-buildroot-scripts/">10. Extra - HPS-buildroot-scripts</a>
    </li>
  

      
        
  
    <li>
      <a href="../Entrega-5/">🔔 Assessment</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-DeviceDriver/">11. Device Driver</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-kernel-module/">12. Kernel Module</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-kernel-chardriver/">13. Char Device Driver</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">HPS + FPGA</span>
    <ul>
      
        
  
    <li>
      <a href="../Tutorial-HPS-FPGA-BlinkLED/">14. Blink FPGA LED from HPS</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-FPGA-VGA/">15. VGA</a>
    </li>
  

      
        
  
    <li>
      <a href="../Entrega-6/">🔔 Assessment</a>
    </li>
  

      
        
  
    <li>
      <a href="../Tutorial-HPS-FPGA-kernel-char-led-driver/">16. Kernel driver</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">High Level Synthesis</span>
    <ul>
      
        
  
    <li>
      <a href="../Tutorial-Acelerando-HLS/">17. Accelerating</a>
    </li>
  

      
        
  
    <li>
      <a href="../🔔 Assessment:"Entrega-Extra-1.md"">None</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Useful</span>
    <ul>
      
        
  
    <li>
      <a href="../info-FPGA-e-Softwares/">Softwares</a>
    </li>
  

      
        
  
    <li>
      <a href="../info-SDcard/">SD card</a>
    </li>
  

      
        
  
    <li>
      <a href="../info-HPS-Serial/">Serial port</a>
    </li>
  

      
        
  
    <li>
      <a href="../info-HPS-ethernet/">Extra - Network</a>
    </li>
  

      
        
  
    <li>
      <a href="../info-VHDL/">Refereces</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Students tutorials</span>
    <ul>
      
        
  
    <li>
      <a href="../Projeto-Overview/">Projeto Overview</a>
    </li>
  

      
        
  
    <li>
      <a href="../Projeto-Rubrica/">Projeto Rubrica</a>
    </li>
  

      
        
  
    <li>
      <a href="https://github.com/Insper/Embarcados-Avancados-Template">Template markdown</a>
    </li>
  

      
        
  
    <li>
      <a href="../2022/tftp/index.md">2022 - TFTP</a>
    </li>
  

      
        
  
    <li>
      <a href="../2022/riscv/">2022 - RISC V</a>
    </li>
  

      
        
  
    <li>
      <a href="../2022/RaSpider/index.md">2022 - RaSpider</a>
    </li>
  

      
        
  
    <li>
      <a href="../2021/Chisel/">2021 - Chisel</a>
    </li>
  

      
        
  
    <li>
      <a href="../2021/RISCV/">2021 - RISC V</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/PS3-Linux-Tutorial/">2020 - PS3 HACK</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/Android/">2020 - Android para Raspbery Pi 3</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/LED-HW/">2020 - IP para fita de LED</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/LED-Linux/">2020 - Driver linux fita de LED</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/python/">2020 - Soc & Python</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/metropolis/">2020 - SDAccel</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/Audio/">2020 - Áudio na DE10</a>
    </li>
  

      
        
  
    <li>
      <a href="../2020/cripto/">2020 - Criptografia em Hardware</a>
    </li>
  

      
        
  
    <li>
      <a href="../2019/Gabriel-TensorFlow/">2019 - TensorFlow</a>
    </li>
  

      
        
  
    <li>
      <a href="../2019/Leo-OpenCL/">2019 - OpenCL</a>
    </li>
  

      
        
  
    <li>
      <a href="../2019/Elisa-Yocto/">2019 - Yocto</a>
    </li>
  

      
        
  
    <li>
      <a href="../2019/Pedro-OpenCV/">2019 - OpenCV</a>
    </li>
  

      
        
  
    <li>
      <a href="../2019/Martim-F1/">2019 - FPGA na AWS</a>
    </li>
  

      
        
  
    <li>
      <a href="../2019/Toranja-DevDriver/">2019 - DeviceDriver</a>
    </li>
  

      
    </ul>
  </li>

            
          </ul>
        </div>
      </nav>
      <main class="ah-content ah-typeset">
        
          <div class="ah-title-box">
            <ul class="ah-breadcrumbs">
              
                
                  
                    <li>HPS</li>
                  
                
                <li></li>
            </ul>
            
            
          </div>
          
            <section class="progress-section show">
<h1 id="compiling-the-kernel">Compiling the Kernel<a class="headerlink" href="#compiling-the-kernel" title="Permanent link">&para;</a></h1>
<p>In this tutorial, we will compile the Linux kernel for our SoC's ARM using the toolchain we already have configured.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Linus</label><label for="__tabbed_1_2">Hans</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><iframe width="560" height="315" src="https://www.youtube.com/embed/SOXeXauRAm0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>
</div>
<div class="tabbed-block">
<p><iframe width="560" height="315" src="https://www.youtube.com/embed/FEfSlk1EHNI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>
</div>
</div>
</div>
<h2 id="kernel-44">Kernel 4.4<a class="headerlink" href="#kernel-44" title="Permanent link">&para;</a></h2>
<p>Clone the Linux kernel:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/torvalds/linux<span class="w"> </span>
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>linux
</code></pre></div>
<blockquote>
<p>This might take a while, the kernel is a large project.</p>
</blockquote>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The official repository of the Linus kernel is: <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</a> however cloning from it is usually much slower than from GitHub (which is just a mirror of the official repository).</p>
</div>
<p>We will work with version <code>4.4</code> of the kernel which is a version with: <code>Long Time Support</code> (LTS), i.e., it will be maintained for much longer than other versions. Version 4.4 was released on January 10 and will be officially maintained until 2021, it is also a version called Super LTS, with extended support until 2036. Think that a developer of an embedded system, who is going to create a whole dedicated infrastructure, doesn't want to have to adjust and validate everything again just to have the newest version of the kernel. The idea of using a version with more support is to minimize efforts with new resources.</p>
<p>The kernel uses the <code>tag</code> system of git:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>tag
...
v2.6.11
v2.6.11-tree
v2.6.12
v2.6.12-rc2
v2.6.12-rc3
v2.6.12-rc4
v2.6.12-rc5
v2.6.12-rc6
v2.6.13-rc2
v2.6.14-rc2
v2.6.14-rc3
...
</code></pre></div>
<p>Note that odd revisions are for Kernel in development stage, and even numbers for production version, example:</p>
<ul>
<li><strong>Linux 2.4.x</strong> - Production</li>
<li><strong>Linux 2.5.x</strong> - Development </li>
<li><strong>Linux 2.6.x</strong> - Production</li>
<li>....</li>
</ul>
<div class="admonition exercise self-progress" data-slug="Tutorial-HPS-Kernel/exercise_1" id="exercise_1_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<p>Let's createa branch of version v4.4, for this execute the following command:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span><span class="m">4</span>.4-SoC<span class="w"> </span>v4.4
</code></pre></div>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<h2 id="configuring-the-kernel">Configuring the Kernel<a class="headerlink" href="#configuring-the-kernel" title="Permanent link">&para;</a></h2>
<p>Once in the <code>4.4-SoC</code> branch we need to configure the kernel for our processor (ARM) and make the necessary configurations in the kernel. First, we will generate a standard configuration file <code>.config</code> for Altera ARM SoCs.</p>
<div class="admonition exercise self-progress" data-slug="Tutorial-HPS-Kernel/exercise_2" id="exercise_2_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm<span class="w">        </span><span class="c1"># indicates the architecture of the Kernel</span>
$<span class="w"> </span>make<span class="w"> </span>socfpga_defconfig<span class="w"> </span><span class="c1"># generates the standard configuration file for SoC</span>
</code></pre></div>
<p>The kernel configuration is saved in the file: <code>.config</code> at the root of the repository. When we execute the command <code>make socfpga_defconfig</code>, it is initialized with some default settings. You can take a look at the folder: <a href="https://github.com/torvalds/linux/blob/master/arch/arm/configs/socfpga_defconfig">linux/arch/arm/configs/socfpga_defconfig</a>.</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div class="admonition exercise self-progress" data-slug="Tutorial-HPS-Kernel/exercise_3" id="exercise_3_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<p>Now we will configure some specific parameters of the Kernel for our application:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>make<span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm<span class="w"> </span>menuconfig<span class="w"> </span>
</code></pre></div>
<p>You may need to install the <strong>libncurses5-dev</strong> package</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libncurses5-dev
</code></pre></div>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<p>This command will open the Linux Kernel configuration interface (there are other options: <code>make xconfig</code>; <code>make config</code>; <code>make gconfig</code>, ...). This interface allows us to select various Kernel configurations. Now we will follow the script proposed in the following tutorial, translated in a reduced way here. </p>
<ul>
<li><a href="https://rocketboards.org/foswiki/Documentation/EmbeddedLinuxBeginnerSGuide">https://rocketboards.org/foswiki/Documentation/EmbeddedLinuxBeginnerSGuide</a></li>
</ul>
<h3 id="configuring">Configuring<a class="headerlink" href="#configuring" title="Permanent link">&para;</a></h3>
<p>Now lets configure the kernel:</p>
<div class="admonition note">
<p class="admonition-title">Exclude/ Include</p>
<p>To <strong>Disable</strong> use the letter <code>N</code> on the keyboard, to include the letter <code>Y</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Doubts?</p>
<p>Most parameters have an explanation, just press <code>?</code> to read about it.</p>
</div>
<p><a class="glightbox" href="../figs/Tutorial-HPS-Kernel%3Aconfig.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../figs/Tutorial-HPS-Kernel%3Aconfig.gif" /></a></p>
<h3 id="automatically-append-version-information-to-the-version-string">Automatically append version information to the version string<a class="headerlink" href="#automatically-append-version-information-to-the-version-string" title="Permanent link">&para;</a></h3>
<ul>
<li>Go to general Setup <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /><ul>
<li><strong>Disable</strong>: Automatically append version information to the version string</li>
</ul>
</li>
</ul>
<details class="note">
<summary>Automatically append version information to the version string</summary>
<ul>
<li>ref :  <a href="https://rocketboards.org/foswiki/Documentation/EmbeddedLinuxBeginnerSGuide#8">https://rocketboards.org/foswiki/Documentation/EmbeddedLinuxBeginnerSGuide#8</a></li>
</ul>
<p>Go into the “General Setup” menu. Uncheck “Automatically append version information to the version string”. This will prevent the kernel from adding extra “version” information to the kernel. Whenever we try to dynamically load a driver (also called kernel modules, as discussed in a later section) the kernel will check to see if the driver was built with the same version of the source code as itself. If it isn’t, it will reject to load that driver. For development, it’s useful to disable these options to make it easier to test out different versions of drivers. In a production system however, it’s recommend to keep this option enabled and only use drivers that were compiled with the correct version of the kernel.
I encourage you to peruse the options in the General Setup menu and see what’s available to you (hitting “?” to view the help info for the highlighted option). Of particular importance to us is the “Embedded System” option (turns on advanced features) and the type of SLAB allocator used (determines how memory will be dynamically allocated in the kernel). If you want to use an initial ram disk or ram filesystem that would be enabled here as well (these will be explained in the next section).
(text extracted from the reference)</p>
</details>
<hr />
<h4 id="enable-loadable-module-support">Enable loadable module support<a class="headerlink" href="#enable-loadable-module-support" title="Permanent link">&para;</a></h4>
<ul>
<li>Go back to the main menu (<code>&lt;ESC&gt;</code> <code>&lt;ESC&gt;</code>) <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /><ul>
<li>Note that <em>Enable loadable module support</em> is enabled.</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p>This allows the kernel to be modified (by loading drivers) after its execution. This will be useful when we develop our own device driver, without the need to recompile the kernel every time we want to test a modification in the code. This is the configuration that allows us to use USBs, SSDs, network cards via the possibility of dynamically loading drivers by the operating system.</p>
</div>
<hr />
<h4 id="support-for-large-2tb-block-devices-and-files">Support for large (2TB+) block devices and files<a class="headerlink" href="#support-for-large-2tb-block-devices-and-files" title="Permanent link">&para;</a></h4>
<ul>
<li>In the main menu <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> Enable the block layer <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /><ul>
<li><strong>Enable</strong>: `Support for large (2TB+) block devices and files</li>
</ul>
</li>
</ul>
<p>`</p>
<div class="admonition note">
<p>This option will allow the use of EXT4 type partitions. If you forget this option and the kernel is on an EXT4 partition, it will be mounted as READ-ONLY.</p>
</div>
<hr />
<h4 id="the-extended-4-ext4-filesystem">The Extended 4 (ext4) filesystem<a class="headerlink" href="#the-extended-4-ext4-filesystem" title="Permanent link">&para;</a></h4>
<ul>
<li>Main menu <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> File systems <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <ul>
<li>Note that it is already selected: <code>The Extended 4 (ext4) filesystem</code></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p>This option will enable the kernel to mount devices formatted in EXT4. We intend to use this on the SDCARD.</p>
</div>
<hr />
<h4 id="altera-socfpga-family">Altera SOCFPGA family<a class="headerlink" href="#altera-socfpga-family" title="Permanent link">&para;</a></h4>
<ul>
<li>Main menu <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> System Type <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /><ul>
<li>Note that it is already selected: <code>Altera SOCFGPA family</code></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p>This indicates to the kernel which will be the device that it will be executed on, note that this option has a new menu where we can enable or not the suspension to RAM.</p>
</div>
<hr />
<h4 id="symmetric-multi-processing">Symmetric Multi-Processing<a class="headerlink" href="#symmetric-multi-processing" title="Permanent link">&para;</a></h4>
<ul>
<li>Main menu <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> Kernel Features <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /><ul>
<li>Note that it is already selected: <code>Symmmetric Multi-Processing</code></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p>This option indicates to the kernel that it should use the two cores present in the ARM HPS of the FPGA. </p>
</div>
<hr />
<h4 id="device-drivers">Device Drivers<a class="headerlink" href="#device-drivers" title="Permanent link">&para;</a></h4>
<ul>
<li>Main menu <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> Device Drivers <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <ul>
<li>Analyze the available drivers...</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p>Indicates which drivers will be compiled along with the kernel, note that we already have configured network drivers (Network device support); GPIO (GPIO Support); RTC; DMA; ... . Remember that we already initialized the <code>.config</code> with a default configuration for Altera SoCs.</p>
</div>
<h3 id="saving">Saving<a class="headerlink" href="#saving" title="Permanent link">&para;</a></h3>
<div class="admonition exercise self-progress" data-slug="Tutorial-HPS-Kernel/exercise_4" id="exercise_4_0">
<p class="admonition-title">Saving</p>
<form class="exercise-form">
<p>Press ESC twice (<code>&lt;ESC&gt;</code>  <code>&lt;ESC&gt;</code>) and save the settings in the <code>.config</code> file</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<h3 id="config">.config<a class="headerlink" href="#config" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Take a look at the generated <code>.config</code> file! Sometimes it's easier to edit directly in it, than having to open the configuration menu and find the place to activate a module.</p>
</div>
<h2 id="compiling">Compiling<a class="headerlink" href="#compiling" title="Permanent link">&para;</a></h2>
<p>The makefile uses the <code>CROSS_COMPILE</code> variable to define the toolchain that will compile the kernel, let's define it as the Linaro GCC recently downloaded and than compile the Linux kernel.</p>
<div class="admonition exercise self-progress" data-slug="Tutorial-HPS-Kernel/exercise_5" id="exercise_5_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<p>Define crosscompile:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span><span class="nv">$GCC_Linaro</span>/arm-linux-gnueabihf-
</code></pre></div>
<p>Compile the kernel:</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm<span class="w"> </span><span class="nv">LOCALVERSION</span><span class="o">=</span><span class="w"> </span>zImage<span class="w"> </span>-j<span class="w"> </span><span class="m">8</span>
</code></pre></div>
<blockquote>
<p><code>-j 8</code> runs the compilation in  4 threads, you can adjust this value to suit your processor.</p>
</blockquote>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div class="admonition note">
<p class="admonition-title">Tip</p>
<p>Add the <code>export CROSS_COMPILE=....</code> to your <code>.bashrc</code> so you don't have to keep typing it every time you have to compile the kernel.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you get the error:</p>
<p><code>"/usr/bin/ld: scripts/dtc/dtc-parser.tab.o:(.bss+0x10): multiple definition of 'yylloc'; scripts/dtc/dtc-lexer.lex.o:(.bss+0x0): first defined here".</code> </p>
<p>It's because there is an incompatibility of the version we are compiling 4.5 with the GCC (from version 9 onwards). There are two solutions:</p>
<ol>
<li>Use gcc9: <a href="https://www.soughttech.com/front/article/17085/viewArticle">https://www.soughttech.com/front/article/17085/viewArticle</a></li>
<li>Apply a patch to the linux kernel that removes the multiple declaration of the variable <code>yylloc</code>, in the root of the kernel:</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>wget<span class="w"> </span>https://github.com/Tomoms/android_kernel_oppo_msm8974/commit/11647f99b4de6bc460e106e876f72fc7af3e54a6.patch
$<span class="w"> </span>git<span class="w"> </span>am<span class="w"> </span>11647f99b4de6bc460e106e876f72fc7af3e54a6.patch
</code></pre></div>
</div>
<div class="admonition fail">
<p class="admonition-title">Fail</p>
<p>If a build error occurs, you should check the path of <code>CROSS_COMPILE</code> or if there is a dependency that has not been met.</p>
</div>
<p>This command causes the Linux kernel to be compiled into a compressed version that is self-extracting. Other options would be:</p>
<ul>
<li>Image: Kernel binary</li>
<li>zImage: compressed version that has <em>self-extracting</em></li>
<li>uImage: a version that already has the uboot bootloader</li>
</ul>
<p>1^: <a href="https://stackoverflow.com/questions/22322304/image-vs-zimage-vs-uimage">https://stackoverflow.com/questions/22322304/image-vs-zimage-vs-uimage</a> </p>
<div class="admonition tip">
<p class="admonition-title">Compiled Kernel</p>
<p>The zImage is saved in:</p>
<ul>
<li><code>arch/arm/boot/zImage</code></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">zImage</p>
<p>This file is the binary that contains the Linux kernel and will be executed on the embedded system.</p>
</div>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<p>Now we need to update the kernel that is on the SDCard so we can test if it is working.</p>
<div class="admonition exercise self-progress" data-slug="Tutorial-HPS-Kernel/exercise_6" id="exercise_6_0">
<p class="admonition-title">Updating the SDCARD</p>
<form class="exercise-form">
<ol>
<li>insert the sdcard into the pc</li>
<li>mount partition 1</li>
<li>replace the zImage that is on the SDCARD by the one generated inside the <code>arch/arm/boot/zImage</code> folder</li>
<li>eject the sdcard or execute the <code>sync</code> command</li>
<li>put the SDCARD in the board and turn on the FPGA</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<p>To verify that everything is set up correctly, simply insert the memory card into the kit and check the version of the running kernel. <mark>Please note that your kernel version and compilation time may differ from mine</mark>.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>uname<span class="w"> </span>-a
Linux<span class="w"> </span>buildroot<span class="w"> </span><span class="m">4</span>.4<span class="w"> </span><span class="c1">#1 SMP Mon Jul 16 21:22:58 -03 2018 armv7l GNU/Linux</span>
</code></pre></div>
<h2 id="mouse-keyboard">Mouse/ Keyboard?<a class="headerlink" href="#mouse-keyboard" title="Permanent link">&para;</a></h2>
<p>Do mouse and keyboard work right away? Try plugging a USB mouse into the board, is it recognized by Linux? It shouldn't be. To work you should go back to the Linux kernel settings and insert the drivers that manage USB and HID. Compile, replace the zImage on the sdcard and test again.</p>
<div class="admonition info">
<p class="admonition-title">How to check if the mouse is working?</p>
<ol>
<li>Type 'lsusb', it should show that it recognized a mouse</li>
<li>After connecting the mouse, type <code>tail dmesg</code>, it should show that it recognized a new USB device and associated it with a mouse</li>
<li>The mouse in linux is mounted on <code>/dev/input/mice</code>, to see if it is working you can execute: <code>cat /dev/input/mice</code>, move the mouse to see if anything appears on the screen</li>
</ol>
</div>
<div class="admonition tip">
<p class="admonition-title">Human Interface Devices (HID)</p>
<p>HID is a type of device recognized by the Linux Kernel as a user interface device, this type of device is usually automatically recognized by the kernels, as they implement a communication standard.</p>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/hid/index.html">https://www.kernel.org/doc/html/latest/hid/index.html</a></li>
</ul>
<p>USB also has a classification of HID type devices, which facilitates their use by the kernel:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/USB_human_interface_device_class">https://en.wikipedia.org/wiki/USB_human_interface_device_class</a></li>
</ul>
</div>


</section>
          
        
      </main>
      <footer class="ah-footer ah-typeset">
        <div class="ah-footer-nav">
          
            <a href="../Entrega-4/"
               class="ah-prev"
               title="🔔 Assessment">
              <span class="nav-label">Previous</span>
              <span class="nav-title">🔔 Assessment</span>
            </a>
          
          
            <a href="../Tutorial-HPS-Buildroot/"
               class="ah-next"
               title="9. Buildroot">
              <span class="nav-label">Next</span>
              <span class="nav-title">9. Buildroot</span>
            </a>
          
        </div>
      </footer>
    </div>
    
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script src="../termynal.js"></script>
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>